<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: <%= typeof bodyBg !== 'undefined' ? bodyBg : (darkMode ? 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)') %>;
            min-height: 100vh;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            padding-bottom: 150px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.2)' %>;
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2em;
            color: <%= darkMode ? '#e5e7eb' : '#fff' %>;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            background: <%= darkMode ? 'linear-gradient(135deg, #374151 0%, #4b5563 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' %>;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.2)' %>;
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .menu-item {
            padding: 12px 15px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.3)' %>;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .menu-item:hover {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.4)' %>;
            transform: translateX(5px);
        }

        .menu-item.active {
            background: <%= darkMode ? 'rgba(139, 92, 246, 0.3)' : 'rgba(139, 92, 246, 0.2)' %>;
            border-left: 4px solid <%= darkMode ? '#8b5cf6' : '#7c3aed' %>;
        }

        .content-area {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.2)' %>;
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed <%= darkMode ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.3)' %>;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.02)' : 'rgba(255, 255, 255, 0.3)' %>;
        }

        .upload-area:hover {
            border-color: <%= darkMode ? '#8b5cf6' : '#7c3aed' %>;
            background: <%= darkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.05)' %>;
        }

        .upload-area h3 {
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            margin-bottom: 10px;
        }

        .upload-area p {
            color: <%= darkMode ? '#9ca3af' : '#6b7280' %>;
        }

        .file-input {
            display: none;
        }

        .paste-url-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.35)' %>;
            border-radius: 8px;
            border: 1px solid <%= darkMode ? 'rgba(255, 255, 255, 0.15)' : 'rgba(0, 0, 0, 0.08)' %>;
        }
        .paste-url-box input {
            width: 220px;
            padding: 8px 12px;
            border: 1px solid <%= darkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.15)' %>;
            border-radius: 6px;
            font-size: 0.9em;
            background: <%= darkMode ? 'rgba(0, 0, 0, 0.2)' : 'rgba(255, 255, 255, 0.8)' %>;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }
        .paste-url-box input::placeholder {
            color: <%= darkMode ? '#9ca3af' : '#6b7280' %>;
        }
        .paste-url-box .url-play-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            background: <%= darkMode ? 'rgba(34, 197, 94, 0.4)' : 'rgba(34, 197, 94, 0.6)' %>;
            color: white;
            white-space: nowrap;
        }
        .paste-url-box .url-play-btn:hover {
            background: rgba(34, 197, 94, 0.8);
        }
        .paste-url-box .url-stop-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            background: <%= darkMode ? 'rgba(239, 68, 68, 0.4)' : 'rgba(239, 68, 68, 0.6)' %>;
            color: white;
        }
        .paste-url-box .url-stop-btn:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        .songs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .song-card {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.3)' %>;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .song-card:hover {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.4)' %>;
            transform: translateY(-5px);
        }

        .song-icon {
            width: 100%;
            height: 150px;
            background: <%= darkMode ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%)' %>;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            margin-bottom: 15px;
        }

        .song-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            font-size: 1.1em;
        }

        .song-info {
            font-size: 0.9em;
            color: <%= darkMode ? '#9ca3af' : '#6b7280' %>;
            margin-bottom: 10px;
        }

        .song-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 12px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.5)' %>;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .action-btn:hover {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.7)' %>;
        }

        .player-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: <%= darkMode ? 'rgba(0, 0, 0, 0.95)' : 'rgba(255, 255, 255, 0.95)' %>;
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }

        .player-section.active {
            display: block;
        }

        .player-content {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 200px;
            gap: 20px;
            align-items: center;
        }

        .now-playing {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .now-playing-thumb {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }

        .now-playing-info h4 {
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            margin-bottom: 5px;
        }

        .now-playing-info p {
            color: <%= darkMode ? '#9ca3af' : '#6b7280' %>;
            font-size: 0.9em;
        }

        .player-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .controls-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' %>;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .control-btn.play-btn {
            width: 50px;
            height: 50px;
            background: <%= darkMode ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : 'linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%)' %>;
            color: white;
            font-size: 1.5em;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.active {
            background: <%= darkMode ? 'rgba(139, 92, 246, 0.3)' : 'rgba(139, 92, 246, 0.2)' %>;
            border: 2px solid <%= darkMode ? '#8b5cf6' : '#7c3aed' %>;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-display {
            color: <%= darkMode ? '#9ca3af' : '#6b7280' %>;
            font-size: 0.9em;
            min-width: 45px;
        }

        .progress-bar {
            flex: 1;
            height: 5px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' %>;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: <%= darkMode ? '#8b5cf6' : '#7c3aed' %>;
            border-radius: 5px;
            width: 0%;
            transition: width 0.1s;
        }

        .player-extras {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            align-items: center;
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .album-card {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.3)' %>;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .album-card:hover {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.4)' %>;
            transform: translateY(-5px);
        }

        .album-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .album-title {
            font-weight: bold;
            font-size: 1.3em;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .album-songs {
            list-style: none;
        }

        .album-song-item {
            padding: 10px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.3)' %>;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .album-song-item:hover {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.5)' %>;
        }

        .create-album-btn {
            padding: 12px 25px;
            background: <%= darkMode ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #34d399 0%, #10b981 100%)' %>;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .create-album-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: <%= darkMode ? '#1f2937' : '#fff' %>;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .close-modal {
            font-size: 1.5em;
            cursor: pointer;
            color: <%= darkMode ? '#9ca3af' : '#6b7280' %>;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: <%= darkMode ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.05)' %>;
            border: 1px solid <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' %>;
            border-radius: 8px;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            font-size: 1em;
        }

        .selected-songs {
            max-height: 200px;
            overflow-y: auto;
            background: <%= darkMode ? 'rgba(0, 0, 0, 0.2)' : 'rgba(0, 0, 0, 0.05)' %>;
            padding: 10px;
            border-radius: 8px;
        }

        .selected-song {
            padding: 8px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.5)' %>;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .remove-song {
            cursor: pointer;
            color: #ef4444;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .player-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <% if (typeof ownerMessage !== 'undefined' && ownerMessage) { %>
    <div class="owner-banner-page" style="max-width: 1600px; margin: 0 auto 20px; margin-left: auto; margin-right: auto; padding: 10px 20px; background: linear-gradient(90deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%); color: white; border-radius: 0 0 12px 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"><strong>üì¢ Console:</strong><%= ownerMessage %></div>
    <% } %>
    <div class="container">
        <div class="header">
            <h1>üéµ Music Player</h1>
            <div class="nav-buttons">
                <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                <div class="paste-url-box" title="Paste a YouTube or direct audio URL ‚Äì only your account can set this">
                    <input type="text" id="backgroundUrlInput" placeholder="Paste URL (YouTube or song link)" spellcheck="false">
                    <button type="button" class="url-play-btn" id="urlPlayBtn" onclick="playBackgroundUrl()">‚ñ∂ Play</button>
                    <button type="button" class="url-stop-btn" id="urlStopBtn" onclick="stopBackgroundUrl()" style="display: none;">Stop</button>
                </div>
                <% } %>
                <a href="/app" class="btn">‚Üê Back to Dashboard</a>
                <a href="/logout" class="btn">üö™ Logout</a>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h3>üéµ Menu</h3>
                <div class="menu-item active" onclick="showSection('library')">üéº My Library</div>
                <div class="menu-item" onclick="showSection('albums')">üìÄ My Albums</div>
                <div class="menu-item" onclick="showSection('shared')">üåê Shared Albums</div>
            </div>

            <div class="content-area">
                <!-- Library Section -->
                <div id="librarySection" class="section active">
                    <h2 style="margin-bottom: 20px;">üéº My Music Library</h2>
                    <div class="upload-section">
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <h3>üìÅ Upload Music Files</h3>
                            <p>Click to select MP3, WAV, or other audio files</p>
                            <p style="margin-top: 10px; font-size: 0.9em;">You can select multiple files at once!</p>
                        </div>
                        <input type="file" id="fileInput" class="file-input" accept="audio/*" multiple onchange="handleFileSelect(event)">
                    </div>
                    <div id="songsGrid" class="songs-grid"></div>
                </div>

                <!-- My Albums Section -->
                <div id="albumsSection" class="section" style="display: none;">
                    <h2 style="margin-bottom: 20px;">üìÄ My Albums</h2>
                    <button class="create-album-btn" onclick="openCreateAlbum()">+ Create New Album</button>
                    <div id="myAlbums" class="album-grid"></div>
                </div>

                <!-- Shared Albums Section -->
                <div id="sharedSection" class="section" style="display: none;">
                    <h2 style="margin-bottom: 20px;">üåê Shared Albums</h2>
                    <div id="sharedAlbums" class="album-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Music Player -->
    <div class="player-section" id="musicPlayer">
        <div class="player-content">
            <div class="now-playing">
                <div class="now-playing-thumb">üéµ</div>
                <div class="now-playing-info">
                    <h4 id="playerTitle">No song playing</h4>
                    <p id="playerArtist">Select a song to play</p>
                </div>
            </div>

            <div class="player-controls">
                <div class="controls-buttons">
                    <button class="control-btn" onclick="previousSong()">‚èÆÔ∏è</button>
                    <button class="control-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂Ô∏è</button>
                    <button class="control-btn" onclick="nextSong()">‚è≠Ô∏è</button>
                    <button class="control-btn" id="loopBtn" onclick="toggleLoop()">üîÅ</button>
                    <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()">üîÄ</button>
                </div>
                <div class="progress-container">
                    <span class="time-display" id="currentTime">0:00</span>
                    <div class="progress-bar" onclick="seekTo(event)">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="time-display" id="totalTime">0:00</span>
                </div>
            </div>

            <div class="player-extras">
                <button class="action-btn" onclick="addCurrentToAlbum()">‚ûï Add to Album</button>
            </div>
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <audio id="lofiBackground" loop preload="auto" style="display: none;"></audio>
    <div id="youtubeBackground" style="position: fixed; left: -9999px; width: 1px; height: 1px; opacity: 0; pointer-events: none;"></div>

    <!-- Create Album Modal -->
    <div class="modal" id="createAlbumModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Album</h3>
                <span class="close-modal" onclick="closeCreateAlbum()">‚úñÔ∏è</span>
            </div>
            <div class="form-group">
                <label for="albumName">Album Name:</label>
                <input type="text" id="albumName" placeholder="Enter album name...">
            </div>
            <div class="form-group">
                <label>Selected Songs:</label>
                <div class="selected-songs" id="selectedSongs">
                    <p style="color: #9ca3af;">No songs selected. Add songs from your library.</p>
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="shareAlbum"> Share this album with all users
                </label>
            </div>
            <button class="btn" onclick="createAlbum()">Create Album</button>
        </div>
    </div>

    <!-- Add to Album Modal -->
    <div class="modal" id="addToAlbumModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add to Album</h3>
                <span class="close-modal" onclick="closeAddToAlbum()">‚úñÔ∏è</span>
            </div>
            <div id="albumsList"></div>
            <button class="btn" onclick="closeAddToAlbum()" style="margin-top: 15px;">Cancel</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const username = '<%= username %>';
        
        let mySongs = [];
        let currentSong = null;
        let currentIndex = 0;
        let isPlaying = false;
        let isLooping = false;
        let isShuffled = false;
        let playlist = [];
        let songsForAlbum = [];
        let myAlbums = [];
        let sharedAlbums = [];

        const audioPlayer = document.getElementById('audioPlayer');
        const lofiAudio = document.getElementById('lofiBackground');
        let backgroundUrlPlaying = false;
        let youtubePlayer = null;
        let currentBackgroundIsYoutube = false;

        console.log('üéµ Music player loaded for:', username);

        // Initialize
        socket.emit('register-user', username);
        loadMySongs();
        loadAlbums();

        if (lofiAudio) lofiAudio.volume = 0.3;

        // Restore UI when returning to Music page; playback stays in popup so it doesn't restart
        try {
            if (localStorage.getItem('backgroundPlaying') === '1') {
                var savedUrl = localStorage.getItem('backgroundUrl') || '';
                var savedYtId = localStorage.getItem('backgroundYoutubeId') || '';
                var input = document.getElementById('backgroundUrlInput');
                if (input) {
                    input.value = savedYtId ? ('https://www.youtube.com/watch?v=' + savedYtId) : savedUrl;
                }
                var stopBtn = document.getElementById('urlStopBtn');
                var playBtn = document.getElementById('urlPlayBtn');
                if (stopBtn) stopBtn.style.display = 'inline-block';
                if (playBtn) playBtn.style.display = 'none';
                backgroundUrlPlaying = true;
                window.open('/background-player', 'appBackgroundPlayer', 'width=320,height=70,left=100,top=100,menubar=no,toolbar=no,status=no');
            }
        } catch (e) {}

        function getYoutubeVideoId(url) {
            if (!url || typeof url !== 'string') return null;
            const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return m ? m[1] : null;
        }
        function isDirectAudioUrl(url) {
            if (!url) return false;
            return /^https?:\/\//i.test(url) && !/youtube|youtu\.be/i.test(url);
        }

        function playBackgroundUrl() {
            const input = document.getElementById('backgroundUrlInput');
            if (!input) return;
            const url = (input.value || '').trim();
            if (!url) {
                alert('Paste a YouTube or direct audio URL first.');
                return;
            }
            const ytId = getYoutubeVideoId(url);
            if (ytId) {
                currentBackgroundIsYoutube = true;
                try { localStorage.setItem('backgroundYoutubeId', ytId); localStorage.setItem('backgroundUrl', ''); } catch (e) {}
            } else if (isDirectAudioUrl(url)) {
                currentBackgroundIsYoutube = false;
                try { localStorage.setItem('backgroundUrl', url); localStorage.setItem('backgroundYoutubeId', ''); } catch (e) {}
            } else {
                alert('Paste a valid YouTube link (youtube.com or youtu.be) or a direct audio URL.');
                return;
            }
            try {
                localStorage.setItem('backgroundPlaying', '1');
            } catch (e) {}
            backgroundUrlPlaying = true;
            window.open('/background-player', 'appBackgroundPlayer', 'width=320,height=70,left=100,top=100,menubar=no,toolbar=no,status=no');
            const playBtn = document.getElementById('urlPlayBtn');
            const stopBtn = document.getElementById('urlStopBtn');
            if (playBtn) playBtn.style.display = 'none';
            if (stopBtn) stopBtn.style.display = 'inline-block';
        }

        function stopBackgroundUrl() {
            if (youtubePlayer && currentBackgroundIsYoutube) {
                try { youtubePlayer.stopVideo(); } catch (e) {}
                youtubePlayer = null;
            }
            if (lofiAudio) {
                lofiAudio.pause();
                lofiAudio.removeAttribute('src');
            }
            backgroundUrlPlaying = false;
            currentBackgroundIsYoutube = false;
            try {
                localStorage.setItem('backgroundPlaying', '0');
            } catch (e) {}
            const playBtn = document.getElementById('urlPlayBtn');
            const stopBtn = document.getElementById('urlStopBtn');
            if (playBtn) playBtn.style.display = 'inline-block';
            if (stopBtn) stopBtn.style.display = 'none';
        }

        function playYoutubeBackground(videoId) {
            const container = document.getElementById('youtubeBackground');
            if (!container) return;
            container.innerHTML = '<div id="ytPlayerEl"></div>';
            if (!window.YT || !window.YT.Player) {
                const tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                const firstScript = document.getElementsByTagName('script')[0];
                firstScript.parentNode.insertBefore(tag, firstScript);
                window.onYouTubeIframeAPIReady = function() {
                    youtubePlayer = new YT.Player('ytPlayerEl', {
                        videoId: videoId,
                        width: 1,
                        height: 1,
                        playerVars: { autoplay: 1, loop: 1, playlist: videoId }
                    });
                };
            } else {
                youtubePlayer = new YT.Player('ytPlayerEl', {
                    videoId: videoId,
                    width: 1,
                    height: 1,
                    playerVars: { autoplay: 1, loop: 1, playlist: videoId }
                });
            }
        }

        function pauseLofi() {
            if (youtubePlayer && currentBackgroundIsYoutube) {
                try { youtubePlayer.pauseVideo(); } catch (e) {}
            }
            if (lofiAudio) lofiAudio.pause();
        }
        function resumeLofi() {
            if (!backgroundUrlPlaying || isPlaying) return;
            if (currentBackgroundIsYoutube && youtubePlayer) {
                try { youtubePlayer.playVideo(); } catch (e) {}
            } else if (lofiAudio && lofiAudio.src) {
                lofiAudio.play().catch(function() {});
            }
        }

        // Socket events
        socket.on('songs-updated', (songs) => {
            console.log('üì• Songs updated:', songs);
            mySongs = songs;
            renderSongs();
        });

        socket.on('albums-updated', (data) => {
            console.log('üìÄ Albums updated:', data);
            myAlbums = data.myAlbums;
            sharedAlbums = data.sharedAlbums;
            renderAlbums();
        });

        // File handling
        function handleFileSelect(event) {
            const files = event.target.files;
            
            if (files.length === 0) return;

            const fileNames = Array.from(files).map(f => f.name).join(', ');
            const confirm = window.confirm(`Would you like to upload ${files.length} song(s)?\n\n${fileNames}`);

            if (confirm) {
                uploadFiles(files);
            }
        }

        function uploadFiles(files) {
            const fileArray = Array.from(files);
            let completed = 0;
            let failed = 0;

            if (fileArray.length === 0) return;

            fileArray.forEach(file => {
                const reader = new FileReader();
                reader.onerror = () => {
                    failed++;
                    checkDone();
                };
                reader.onload = (e) => {
                    const song = {
                        id: Date.now() + Math.random(),
                        name: file.name.replace(/\.[^/.]+$/, ""),
                        size: formatFileSize(file.size),
                        type: file.type,
                        audioData: e.target.result,
                        username: username,
                        uploadedAt: new Date().toISOString()
                    };
                    socket.emit('upload-song', song);
                    completed++;
                    checkDone();
                };
                reader.readAsDataURL(file);
            });

            function checkDone() {
                if (completed + failed === fileArray.length) {
                    if (failed > 0) {
                        alert('‚ö†Ô∏è ' + completed + ' uploaded, ' + failed + ' failed. Large files may exceed the size limit.');
                    } else {
                        alert('‚úÖ Songs uploaded successfully! They should appear in your library shortly.');
                    }
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function loadMySongs() {
            socket.emit('get-my-songs', username);
        }

        function renderSongs() {
            const grid = document.getElementById('songsGrid');
            
            if (mySongs.length === 0) {
                grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #9ca3af;">No songs yet. Upload some music to get started!</p>';
                return;
            }

            grid.innerHTML = mySongs.map(song => `
                <div class="song-card">
                    <div class="song-icon">üéµ</div>
                    <div class="song-title">${escapeHtml(song.name)}</div>
                    <div class="song-info">${song.size}</div>
                    <div class="song-actions">
                        <button class="action-btn" onclick='playSong(${JSON.stringify(song)})'>‚ñ∂Ô∏è Play</button>
                        <button class="action-btn" onclick='addSongForAlbum(${JSON.stringify(song)})'>‚ûï Add to Album</button>
                        <button class="action-btn" onclick="deleteSong(${song.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function playSong(song) {
            currentSong = song;
            try { localStorage.setItem('mainPlayerPlaying', '1'); } catch (e) {}
            pauseLofi();
            document.getElementById('musicPlayer').classList.add('active');
            document.getElementById('playerTitle').textContent = song.name;
            document.getElementById('playerArtist').textContent = `Uploaded by ${song.username}`;
            audioPlayer.src = song.audioData;
            audioPlayer.play();
            isPlaying = true;
            document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
        }

        function togglePlayPause() {
            if (!currentSong) {
                alert('No song selected! Please select a song to play.');
                return;
            }
            if (isPlaying) {
                audioPlayer.pause();
                document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
                try { localStorage.setItem('mainPlayerPlaying', '0'); } catch (e) {}
                resumeLofi();
            } else {
                try { localStorage.setItem('mainPlayerPlaying', '1'); } catch (e) {}
                pauseLofi();
                audioPlayer.play();
                document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
            }
            isPlaying = !isPlaying;
        }

        function toggleLoop() {
            isLooping = !isLooping;
            audioPlayer.loop = isLooping;
            document.getElementById('loopBtn').classList.toggle('active');
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            document.getElementById('shuffleBtn').classList.toggle('active');
        }

        function previousSong() {
            if (playlist.length > 0 && currentIndex > 0) {
                currentIndex--;
                playSong(playlist[currentIndex]);
            }
        }

        function nextSong() {
            if (playlist.length > 0) {
                if (isShuffled) {
                    currentIndex = Math.floor(Math.random() * playlist.length);
                } else if (currentIndex < playlist.length - 1) {
                    currentIndex++;
                } else {
                    currentIndex = 0;
                }
                playSong(playlist[currentIndex]);
            }
        }

        function seekTo(event) {
            const progressBar = event.currentTarget;
            const clickX = event.offsetX;
            const width = progressBar.offsetWidth;
            const duration = audioPlayer.duration;
            
            audioPlayer.currentTime = (clickX / width) * duration;
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // Update progress bar and time
        audioPlayer.addEventListener('timeupdate', () => {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('progressFill').style.width = (progress || 0) + '%';
            document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
            document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
        });

        // Auto play next song; tell popup to resume when nothing is playing
        audioPlayer.addEventListener('ended', () => {
            if (!isLooping) {
                nextSong();
                if (playlist.length === 0) try { localStorage.setItem('mainPlayerPlaying', '0'); } catch (e) {}
            }
        });

        function deleteSong(songId) {
            if (confirm('Are you sure you want to delete this song?')) {
                socket.emit('delete-song', { songId, username });
            }
        }

        // Show sections
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));

            if (section === 'library') {
                document.getElementById('librarySection').style.display = 'block';
                document.querySelectorAll('.menu-item')[0].classList.add('active');
            } else if (section === 'albums') {
                document.getElementById('albumsSection').style.display = 'block';
                document.querySelectorAll('.menu-item')[1].classList.add('active');
                renderAlbums();
            } else if (section === 'shared') {
                document.getElementById('sharedSection').style.display = 'block';
                document.querySelectorAll('.menu-item')[2].classList.add('active');
                renderAlbums();
            }
        }

        // Album functions
        function addSongForAlbum(song) {
            if (!songsForAlbum.find(s => s.id === song.id)) {
                songsForAlbum.push(song);
                alert('‚úÖ Song added! Click "Create New Album" to save it.');
            } else {
                alert('‚ö†Ô∏è Song already added!');
            }
        }

        function openCreateAlbum() {
            if (songsForAlbum.length === 0) {
                alert('‚ö†Ô∏è Please add songs first! Click "Add to Album" on songs in your library.');
                return;
            }

            const selectedSongsDiv = document.getElementById('selectedSongs');
            selectedSongsDiv.innerHTML = songsForAlbum.map((song, index) => `
                <div class="selected-song">
                    <span>${escapeHtml(song.name)}</span>
                    <span class="remove-song" onclick="removeSongFromList(${index})">‚úñÔ∏è</span>
                </div>
            `).join('');

            document.getElementById('createAlbumModal').classList.add('active');
        }

        function closeCreateAlbum() {
            document.getElementById('createAlbumModal').classList.remove('active');
        }

        function removeSongFromList(index) {
            songsForAlbum.splice(index, 1);
            if (songsForAlbum.length === 0) {
                closeCreateAlbum();
                alert('‚ö†Ô∏è No songs left in album. Add more songs to create an album.');
            } else {
                openCreateAlbum();
            }
        }

        function createAlbum() {
            const name = document.getElementById('albumName').value.trim();
            const shared = document.getElementById('shareAlbum').checked;

            if (!name) {
                alert('‚ö†Ô∏è Please enter an album name!');
                return;
            }

            const album = {
                id: Date.now(),
                name,
                songs: songsForAlbum,
                owner: username,
                shared,
                createdAt: new Date().toISOString()
            };

            socket.emit('create-album', album);
            
            songsForAlbum = [];
            document.getElementById('albumName').value = '';
            document.getElementById('shareAlbum').checked = false;
            closeCreateAlbum();
            
            alert('‚úÖ Album created successfully!');
            showSection('albums');
        }

        function loadAlbums() {
            socket.emit('get-albums', username);
        }

        function renderAlbums() {
            // My Albums
            const myAlbumsDiv = document.getElementById('myAlbums');
            if (myAlbums.length === 0) {
                myAlbumsDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #9ca3af;">No albums yet. Create your first album!</p>';
            } else {
                myAlbumsDiv.innerHTML = myAlbums.map(album => `
                    <div class="album-card">
                        <div class="album-header">
                            <div class="album-title">${escapeHtml(album.name)}</div>
                            <button class="action-btn" onclick="deleteAlbum(${album.id})">üóëÔ∏è</button>
                        </div>
                        <p style="color: #9ca3af; margin-bottom: 10px;">${album.songs.length} songs ${album.shared ? '¬∑ Shared üåê' : ''}</p>
                        <ul class="album-songs">
                            ${album.songs.map((song, index) => `
                                <li class="album-song-item" onclick='playAlbumSong(${JSON.stringify(album.songs)}, ${index})'>
                                    ${escapeHtml(song.name)}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `).join('');
            }

            // Shared Albums
            const sharedAlbumsDiv = document.getElementById('sharedAlbums');
            if (sharedAlbums.length === 0) {
                sharedAlbumsDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #9ca3af;">No shared albums yet.</p>';
            } else {
                sharedAlbumsDiv.innerHTML = sharedAlbums.map(album => `
                    <div class="album-card">
                        <div class="album-header">
                            <div class="album-title">${escapeHtml(album.name)}</div>
                            <span style="color: #9ca3af;">by ${album.owner}</span>
                        </div>
                        <p style="color: #9ca3af; margin-bottom: 10px;">${album.songs.length} songs</p>
                        <ul class="album-songs">
                            ${album.songs.map((song, index) => `
                                <li class="album-song-item" onclick='playAlbumSong(${JSON.stringify(album.songs)}, ${index})'>
                                    ${escapeHtml(song.name)}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `).join('');
            }
        }

        function playAlbumSong(songs, index) {
            playlist = songs;
            currentIndex = index;
            playSong(songs[index]);
        }

        function deleteAlbum(albumId) {
            if (confirm('Are you sure you want to delete this album?')) {
                socket.emit('delete-album', { albumId, username });
            }
        }

        function addCurrentToAlbum() {
            if (!currentSong) {
                alert('‚ö†Ô∏è No song is currently playing!');
                return;
            }

            const albumsListDiv = document.getElementById('albumsList');
            if (myAlbums.length === 0) {
                albumsListDiv.innerHTML = '<p style="color: #9ca3af;">You have no albums. Create one first!</p>';
            } else {
                albumsListDiv.innerHTML = myAlbums.map(album => `
                    <button class="action-btn" style="display: block; width: 100%; margin-bottom: 10px; padding: 12px;" onclick="addSongToAlbum(${album.id})">
                        ${escapeHtml(album.name)} (${album.songs.length} songs)
                    </button>
                `).join('');
            }

            document.getElementById('addToAlbumModal').classList.add('active');
        }

        function closeAddToAlbum() {
            document.getElementById('addToAlbumModal').classList.remove('active');
        }

        function addSongToAlbum(albumId) {
            socket.emit('add-song-to-album', { albumId, song: currentSong, username });
            alert('‚úÖ Song added to album!');
            closeAddToAlbum();
        }
    </script>
</body>
</html>