<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar & Tasks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: <%= typeof bodyBg !== 'undefined' ? bodyBg : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' %>;
            min-height: 100vh;
            padding: 20px;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.2)' %>;
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2em;
            color: <%= darkMode ? '#e5e7eb' : '#fff' %>;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.15)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' %>;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .calendar-section {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.2)' %>;
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .month-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .month-nav button {
            padding: 8px 15px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.3)' %>;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .month-nav button:hover {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.15)' : 'rgba(255, 255, 255, 0.4)' %>;
        }

        .month-nav h2 {
            font-size: 1.5em;
            min-width: 250px;
            text-align: center;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .year-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .year-selector label {
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            font-weight: bold;
        }

        .year-selector select {
            padding: 8px 15px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.3)' %>;
            border: none;
            border-radius: 8px;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            font-size: 1em;
            cursor: pointer;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.3)' %>;
            border-radius: 8px;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .day {
            aspect-ratio: 1;
            padding: 10px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.2)' %>;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
        }

        .day:hover {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.3)' %>;
            transform: scale(1.05);
        }

        .day.today {
            background: rgba(99, 102, 241, 0.2);
            border: 2px solid #4f46e5;
        }

        .day.other-month {
            opacity: 0.3;
        }

        .day.selected {
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid #7c3aed;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .day-tasks {
            flex: 1;
            overflow: hidden;
        }

        .task-dot {
            width: 6px;
            height: 6px;
            background: #059669;
            border-radius: 50%;
            display: inline-block;
            margin: 2px;
        }

        .tasks-section {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.2)' %>;
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: 800px;
            overflow-y: auto;
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tasks-header h3 {
            font-size: 1.3em;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .add-task-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .add-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .task-form {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.3)' %>;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .task-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.5)' %>;
            border: 1px solid <%= darkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)' %>;
            border-radius: 8px;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
            font-size: 1em;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
        }

        .task-item {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.2)' %>;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            background: <%= darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.3)' %>;
            transform: translateX(5px);
        }

        .task-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .task-title {
            font-weight: bold;
            font-size: 1.1em;
            color: <%= darkMode ? '#e5e7eb' : '#1f2937' %>;
        }

        .task-time {
            font-size: 0.9em;
            color: <%= darkMode ? '#9ca3af' : '#6b7280' %>;
        }

        .task-description {
            margin-bottom: 10px;
            color: <%= darkMode ? '#d1d5db' : '#374151' %>;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .task-actions button {
            padding: 5px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .complete-btn {
            background: #34d399;
            color: white;
        }

        .delete-btn {
            background: #f87171;
            color: white;
        }

        .task-actions button:hover {
            transform: scale(1.05);
        }

        .no-tasks {
            text-align: center;
            padding: 40px;
            color: <%= darkMode ? '#9ca3af' : '#6b7280' %>;
            font-size: 1.1em;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <% if (typeof ownerMessage !== 'undefined' && ownerMessage) { %>
    <div class="owner-banner-page" style="max-width: 1400px; margin: 0 auto 20px; background: linear-gradient(90deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%); color: white; padding: 10px 20px; border-radius: 0 0 12px 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"><strong>üì¢ Console:</strong><%= ownerMessage %></div>
    <% } %>
    <div class="container">
        <div class="header">
            <h1>üìÖ Calendar & Tasks</h1>
            <div class="nav-buttons">
                <a href="/app" class="btn">‚Üê Back to Dashboard</a>
                <a href="/logout" class="btn">üö™ Logout</a>
            </div>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="calendar-controls">
                    <div class="month-nav">
                        <button onclick="previousMonth()">‚óÄ</button>
                        <h2 id="currentMonth"></h2>
                        <button onclick="nextMonth()">‚ñ∂</button>
                    </div>
                    <div class="year-selector">
                        <label for="yearSelect">Year:</label>
                        <select id="yearSelect" onchange="changeYear()">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                </div>

                <div class="calendar" id="calendar"></div>
            </div>

            <div class="tasks-section">
                <div class="tasks-header">
                    <h3 id="tasksTitle">All Tasks</h3>
                    <button class="add-task-btn" onclick="toggleTaskForm()">+ Add Task</button>
                </div>

                <div class="task-form" id="taskForm">
                    <div class="form-group">
                        <label for="taskTitle">Task Title:</label>
                        <input type="text" id="taskTitle" placeholder="Enter task title..." required>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description:</label>
                        <textarea id="taskDescription" placeholder="Enter task description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskDate">Date:</label>
                        <input type="date" id="taskDate" required>
                    </div>
                    <div class="form-group">
                        <label for="taskTime">Time (optional):</label>
                        <input type="time" id="taskTime">
                    </div>
                    <div class="form-buttons">
                        <button class="btn" onclick="saveTask()">üíæ Save Task</button>
                        <button class="btn" onclick="toggleTaskForm()">‚ùå Cancel</button>
                    </div>
                </div>

                <div id="tasksList"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const username = '<%= username %>';
        let currentDate = new Date();
        let selectedDate = null;
        let tasks = [];

        console.log('üìÖ Calendar loaded for user:', username);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ DOM loaded, initializing calendar...');
            renderCalendar();
            loadTasks();
        });

        // Socket events
        socket.on('connect', () => {
            console.log('üîå Socket connected');
            socket.emit('register-user', username);
        });

        socket.on('tasks-updated', (updatedTasks) => {
            console.log('üìã Tasks updated:', updatedTasks);
            tasks = updatedTasks;
            renderTasks();
            renderCalendar();
        });

        socket.on('connect_error', (error) => {
            console.error('‚ùå Socket connection error:', error);
        });

        // Calendar functions
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayIndex = firstDay.getDay();
            const lastDayDate = lastDay.getDate();
            const prevLastDayDate = prevLastDay.getDate();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
            document.getElementById('yearSelect').value = year;
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Previous month days
            for (let i = firstDayIndex; i > 0; i--) {
                const day = createDayElement(prevLastDayDate - i + 1, true, new Date(year, month - 1, prevLastDayDate - i + 1));
                calendar.appendChild(day);
            }
            
            // Current month days
            for (let i = 1; i <= lastDayDate; i++) {
                const day = createDayElement(i, false, new Date(year, month, i));
                calendar.appendChild(day);
            }
            
            // Next month days
            const remainingDays = 42 - (firstDayIndex + lastDayDate);
            for (let i = 1; i <= remainingDays; i++) {
                const day = createDayElement(i, true, new Date(year, month + 1, i));
                calendar.appendChild(day);
            }
        }

        function createDayElement(dayNumber, isOtherMonth, date) {
            const day = document.createElement('div');
            day.className = 'day';
            
            if (isOtherMonth) {
                day.classList.add('other-month');
            }
            
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                day.classList.add('today');
            }
            
            if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
                day.classList.add('selected');
            }
            
            const dayNumber_div = document.createElement('div');
            dayNumber_div.className = 'day-number';
            dayNumber_div.textContent = dayNumber;
            day.appendChild(dayNumber_div);
            
            const dayTasks_div = document.createElement('div');
            dayTasks_div.className = 'day-tasks';
            
            const dateTasks = tasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate.toDateString() === date.toDateString();
            });
            
            dateTasks.forEach(() => {
                const dot = document.createElement('span');
                dot.className = 'task-dot';
                dayTasks_div.appendChild(dot);
            });
            
            day.appendChild(dayTasks_div);
            
            day.onclick = () => selectDate(date);
            
            return day;
        }

        function selectDate(date) {
            selectedDate = date;
            renderCalendar();
            renderTasks();
            
            const formattedDate = date.toISOString().split('T')[0];
            document.getElementById('taskDate').value = formattedDate;
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('tasksTitle').textContent = `Tasks for ${date.toLocaleDateString('en-US', options)}`;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function changeYear() {
            const year = parseInt(document.getElementById('yearSelect').value);
            currentDate.setFullYear(year);
            renderCalendar();
        }

        // Task functions
        function toggleTaskForm() {
            const form = document.getElementById('taskForm');
            form.classList.toggle('active');
        }

        function saveTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const date = document.getElementById('taskDate').value;
            const time = document.getElementById('taskTime').value;
            
            if (!title || !date) {
                alert('Please enter a title and date!');
                return;
            }
            
            const task = {
                id: Date.now(),
                title,
                description,
                date,
                time,
                completed: false,
                username: username
            };
            
            console.log('üíæ Saving task:', task);
            socket.emit('add-task', task);
            
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskTime').value = '';
            
            toggleTaskForm();
        }

        function loadTasks() {
            console.log('üì• Loading tasks for user:', username);
            socket.emit('get-tasks', username);
        }

        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            
            let filteredTasks = tasks;
            if (selectedDate) {
                filteredTasks = tasks.filter(task => {
                    const taskDate = new Date(task.date);
                    return taskDate.toDateString() === selectedDate.toDateString();
                });
            }
            
            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '<div class="no-tasks">üìù No tasks for this day. Click "+ Add Task" to create one!</div>';
                return;
            }
            
            filteredTasks.sort((a, b) => {
                const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                return dateA - dateB;
            });
            
            tasksList.innerHTML = filteredTasks.map(task => {
                const escapedTitle = escapeHtml(task.title);
                const escapedDescription = task.description ? escapeHtml(task.description) : '';
                
                return `
                    <div class="task-item ${task.completed ? 'completed' : ''}">
                        <div class="task-header">
                            <div class="task-title">${escapedTitle}</div>
                            <div class="task-time">${task.time || 'No time set'}</div>
                        </div>
                        ${task.description ? `<div class="task-description">${escapedDescription}</div>` : ''}
                        <div class="task-actions">
                            <button class="complete-btn" onclick="toggleComplete(${task.id})">
                                ${task.completed ? '‚Ü©Ô∏è Undo' : '‚úì Complete'}
                            </button>
                            <button class="delete-btn" onclick="deleteTask(${task.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleComplete(taskId) {
            console.log('‚úÖ Toggling task:', taskId);
            socket.emit('toggle-task', { taskId, username });
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                console.log('üóëÔ∏è Deleting task:', taskId);
                socket.emit('delete-task', { taskId, username });
            }
        }

        // Auto-logout prevention
        let isNavigating = false;
        document.querySelectorAll('a, button[type="submit"]').forEach(element => {
            element.addEventListener('click', () => {
                isNavigating = true;
            });
        });
    </script>
</body>
</html>